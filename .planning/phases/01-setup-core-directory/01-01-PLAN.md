---
phase: 01-setup-core-directory
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - .env.example
  - drizzle.config.ts
  - src/lib/db/schema.ts
  - src/lib/db/index.ts
  - src/types/index.ts
  - drizzle/migrations/0000_initial.sql
autonomous: true

must_haves:
  truths:
    - "Database can store listings with geospatial coordinates"
    - "TypeScript types prevent invalid data structures"
    - "Database schema supports full-text search"
  artifacts:
    - path: "src/lib/db/schema.ts"
      provides: "Listing table with PostGIS geometry column"
      contains: "export const listings"
    - path: "src/types/index.ts"
      provides: "TypeScript interfaces for Listing and Category"
      exports: ["Listing", "Category"]
    - path: "drizzle.config.ts"
      provides: "Drizzle ORM configuration"
      contains: "dialect: 'postgresql'"
  key_links:
    - from: "src/lib/db/schema.ts"
      to: "src/types/index.ts"
      via: "InferSelectModel type generation"
      pattern: "InferSelectModel.*listings"
---

<objective>
Establish the Next.js 15 foundation and PostgreSQL database with PostGIS for geospatial directory functionality.

Purpose: Create the data layer and type-safe infrastructure that all other features depend on.
Output: Working Next.js 15 project with Drizzle ORM connected to PostgreSQL database, ready for component development.
</objective>

<execution_context>
@/Users/vincecain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vincecain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/vincecain/Projects/nextgen-preservation-directory/.planning/PROJECT.md
@/Users/vincecain/Projects/nextgen-preservation-directory/.planning/ROADMAP.md
@/Users/vincecain/Projects/nextgen-preservation-directory/.planning/STATE.md
@/Users/vincecain/Projects/nextgen-preservation-directory/.planning/phases/01-setup-core-directory/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Initialize Next.js 15 project with dependencies</name>
  <files>
    package.json
    .env.example
    tsconfig.json
    next.config.ts
  </files>
  <action>
    Create new Next.js 15 project using `npx create-next-app@latest` with App Router, TypeScript, Tailwind CSS, and ESLint enabled. Use `src/` directory structure.

    Install core dependencies:
    - Drizzle ORM: `drizzle-orm`, `drizzle-kit`
    - PostgreSQL: `postgres` (Neon serverless driver)
    - Geospatial: PostGIS (server extension, no npm package needed)
    - Validation: `zod`
    - Utilities: `clsx`, `tailwind-merge`, `date-fns`

    Create .env.example with:
    ```
    DATABASE_URL=postgresql://user:password@host:5432/dbname
    NEXT_PUBLIC_APP_URL=http://localhost:3000
    ```

    Per research: Next.js 15 stable, Drizzle recommended over Prisma for edge-ready footprint.
  </action>
  <verify>
    Run `npm run dev` and verify Next.js starts on http://localhost:3000
    Run `npm list drizzle-orm` to confirm installation
  </verify>
  <done>
    Next.js 15 project runs successfully with all dependencies installed, .env.example created
  </done>
</task>

<task type="auto">
  <name>Create database schema with PostGIS support</name>
  <files>
    drizzle.config.ts
    src/lib/db/schema.ts
    src/lib/db/index.ts
  </files>
  <action>
    Configure Drizzle in drizzle.config.ts:
    ```typescript
    import { defineConfig } from 'drizzle-kit';
    export default defineConfig({
      schema: './src/lib/db/schema.ts',
      out: './drizzle/migrations',
      dialect: 'postgresql',
      dbCredentials: {
        url: process.env.DATABASE_URL!,
      },
    });
    ```

    Create src/lib/db/schema.ts with listings table:
    - id: uuid primary key
    - name: varchar(255) not null
    - description: text
    - role: varchar(100) not null (category)
    - specialties: text[] (array of specialties)
    - address: varchar(500)
    - phone: varchar(20)
    - email: varchar(255)
    - website: varchar(500)
    - image_url: varchar(500)
    - location: geometry(Point, 4326) using PostGIS (lat/lng storage)
    - projects: jsonb (array of {title, description, image_url})
    - status: enum('draft', 'pending', 'approved', 'rejected') default 'draft'
    - created_at: timestamp default now()
    - updated_at: timestamp default now()
    - search_vector: tsvector (full-text search index)

    Add GiST index on location for geospatial queries.
    Add GIN index on search_vector for full-text search.
    Add index on role for category filtering.

    Create database client in src/lib/db/index.ts using Neon serverless driver.

    Per research: PostGIS geometry column with SRID 4326 (WGS84 standard), tsvector for PostgreSQL full-text search.
  </action>
  <verify>
    Run `npm run drizzle-kit generate` to create migration
    Check drizzle/migrations/ for SQL file containing CREATE TABLE with PostGIS geometry column
  </verify>
  <done>
    Database schema defined with PostGIS geometry column, full-text search support, and proper indexes
  </done>
</task>

<task type="auto">
  <name>Generate TypeScript types and setup type safety</name>
  <files>
    src/types/index.ts
    src/lib/validation/listing.ts
  </files>
  <action>
    Create src/types/index.ts:
    - Export Category type: 'Builder' | 'Craftsperson' | 'Tradesperson' | 'Developer' | 'Investor' | 'Advocate' | 'Architect' | 'Government' | 'Nonprofit' | 'Educator'
    - Infer Listing type from Drizzle schema using InferSelectModel
    - Export ListingProject interface for portfolio items
    - Export SearchParams interface for URL query params

    Create src/lib/validation/listing.ts with Zod schemas:
    - listingSchema: Validates listing data structure
    - searchParamsSchema: Validates URL search parameters

    Per research: Use Zod for runtime validation, Drizzle InferSelectModel for compile-time type safety.
  </action>
  <verify>
    Run `npm run build` and verify no TypeScript errors
    Check that src/types/index.ts exports Listing and Category types
  </verify>
  <done>
    TypeScript types generated from schema, Zod validation schemas created, no build errors
  </done>
</task>

</tasks>

<verification>
1. Next.js 15 project runs on http://localhost:3000
2. Database schema file exists with PostGIS geometry column
3. TypeScript build completes without errors
4. All dependencies listed in package.json
</verification>

<success_criteria>
- Next.js 15 App Router project initialized with TypeScript and Tailwind
- Drizzle ORM configured with PostgreSQL connection
- Database schema includes listings table with PostGIS geometry and full-text search
- TypeScript types exported and validated with Zod
- Project builds successfully with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-setup-core-directory/01-01-SUMMARY.md`
</output>
