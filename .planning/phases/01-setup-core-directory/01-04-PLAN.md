---
phase: 01-setup-core-directory
plan: 04
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/lib/queries/search.ts
  - src/components/search/SearchBar.tsx
  - src/components/search/FilterPanel.tsx
  - src/app/(public)/page.tsx
  - src/lib/hooks/useSearchParams.ts
autonomous: true

must_haves:
  truths:
    - "User can search listings by name, specialty, or keyword with instant results"
    - "User can filter listings by category and location"
    - "Search and filter state persists in URL for shareable links"
  artifacts:
    - path: "src/lib/queries/search.ts"
      provides: "Full-text search and filter queries"
      exports: ["searchListings", "filterListings"]
    - path: "src/components/search/SearchBar.tsx"
      provides: "Search input with debouncing"
      contains: "useDebounce"
    - path: "src/components/search/FilterPanel.tsx"
      provides: "Category and location filter controls"
      min_lines: 40
  key_links:
    - from: "src/components/search/SearchBar.tsx"
      to: "URL search params"
      via: "useRouter and URLSearchParams"
      pattern: "searchParams.*set.*q"
    - from: "src/app/(public)/page.tsx"
      to: "src/lib/queries/search.ts"
      via: "Server Component with searchParams prop"
      pattern: "searchParams.*searchListings"
---

<objective>
Implement full-text search and filtering system using PostgreSQL search capabilities and URL-based state management.

Purpose: Enable users to quickly find relevant stakeholders, fulfilling SRCH-01, SRCH-02, and SRCH-04 requirements.
Output: Working search bar and filter panel that update URL and fetch filtered results from database.
</objective>

<execution_context>
@/Users/vincecain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vincecain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/vincecain/Projects/nextgen-preservation-directory/.planning/PROJECT.md
@/Users/vincecain/Projects/nextgen-preservation-directory/.planning/ROADMAP.md
@/Users/vincecain/Projects/nextgen-preservation-directory/.planning/STATE.md
@/Users/vincecain/Projects/nextgen-preservation-directory/.planning/phases/01-setup-core-directory/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Implement PostgreSQL full-text search queries</name>
  <files>
    src/lib/queries/search.ts
  </files>
  <action>
    Create src/lib/queries/search.ts with advanced query functions:

    `searchListings(params)`: Accept { query, role, location } parameters. Build Drizzle query that:
    - Uses PostgreSQL full-text search on search_vector column with plainto_tsquery() for the query parameter
    - Filters by role (category) if provided using WHERE clause
    - Filters by location if provided (simple text match on address for Phase 1 â€” PostGIS radius search is Phase 2 enhancement)
    - Ranks results by ts_rank() relevance when query is present
    - Orders by relevance DESC (if search query) or name ASC (if filtering only)
    - Returns only approved listings (status = 'approved')
    - Limits to 100 results for performance

    Add support for empty/null parameters (return all approved listings if no filters).

    Handle typos using similarity() if search_vector returns zero results (fallback to trigram similarity on name field with threshold 0.3).

    Per research: PostgreSQL full-text search with tsvector (Pattern 3), typo tolerance to avoid "search that doesn't search" pitfall.
  </action>
  <verify>
    Write test queries with various search terms and filters
    Verify results are ranked by relevance
    Test typo tolerance (e.g., "masonry" vs "masonary")
    Check that filters combine correctly (role AND query)
  </verify>
  <done>
    Search query function created with full-text search, filtering, ranking, and typo tolerance
  </done>
</task>

<task type="auto">
  <name>Create SearchBar component with debouncing</name>
  <files>
    src/components/search/SearchBar.tsx
    src/lib/hooks/useSearchParams.ts
  </files>
  <action>
    Install use-debounce: `npm install use-debounce`

    Create src/lib/hooks/useSearchParams.ts:
    - Custom hook wrapping Next.js useSearchParams and useRouter
    - Provides updateSearchParam(key, value) function that updates URL search params
    - Handles URLSearchParams API and router.push()

    Create src/components/search/SearchBar.tsx as Client Component ('use client'):
    - Accept defaultValue prop (from server searchParams)
    - Use local state for input value
    - Use useDebounce from use-debounce with 300ms delay
    - On debounced value change, call updateSearchParam('q', value)
    - Use shadcn/ui Input component for consistent styling
    - Include search icon (lucide-react Search icon)
    - Placeholder: "Search by name, specialty, or keyword..."
    - Clear button (X icon) to reset search

    Per research: URL-based state management (Pattern 2) for shareable links, debouncing to prevent excessive queries.
  </action>
  <verify>
    Type in SearchBar and verify URL updates after 300ms delay
    Check that page re-renders with filtered results
    Verify clear button resets search and URL
    Test that initial value loads from URL searchParams
  </verify>
  <done>
    SearchBar component updates URL with debounced input, clear button works, URL state syncs correctly
  </done>
</task>

<task type="auto">
  <name>Create FilterPanel component for category and location</name>
  <files>
    src/components/search/FilterPanel.tsx
    src/app/(public)/page.tsx
  </files>
  <action>
    Create src/components/search/FilterPanel.tsx as Client Component ('use client'):
    - Use same useSearchParams hook for URL state management
    - Category filter: Select dropdown with all 10 categories from PROJECT.md (Builder, Craftsperson, Tradesperson, Developer, Investor, Advocate, Architect, Government, Nonprofit, Educator)
    - Include "All Categories" default option
    - Location filter: Text input for neighborhood/area search (simple text match for Phase 1)
    - Use shadcn/ui Select component for category dropdown
    - Each filter change updates URL immediately (no debounce needed for select)
    - Display active filters as removable chips/badges above results
    - Responsive: Stack filters vertically on mobile, horizontal on desktop

    Update src/app/(public)/page.tsx:
    - Add searchParams prop type: { q?: string; role?: string; location?: string }
    - Call searchListings(searchParams) instead of getListings()
    - Pass SearchBar and FilterPanel above ListingGrid
    - Handle loading state with React Suspense for search results

    Per research: URL-based filtering for bookmarkable results, shadcn/ui components for consistency.
  </action>
  <verify>
    Select category filter and verify URL updates with role parameter
    Enter location and verify URL updates with location parameter
    Combine search + filters and verify results update correctly
    Check that URL can be copied and pasted to another browser with same results
    Test mobile layout with stacked filters
  </verify>
  <done>
    FilterPanel updates URL with category and location filters, results refresh correctly, filters work in combination with search
  </done>
</task>

</tasks>

<verification>
1. SearchBar updates URL and fetches filtered results with 300ms debounce
2. FilterPanel updates URL with category and location filters
3. Search and filters work in combination
4. Results are ranked by relevance when searching
5. URL can be shared and produces same results
6. Typo tolerance works for common misspellings
</verification>

<success_criteria>
- PostgreSQL full-text search query implemented with ranking
- SearchBar component updates URL with debounced input
- FilterPanel provides category and location filtering
- URL state management enables shareable search results
- Search and filters combine correctly
- Typo tolerance prevents zero-result searches for minor misspellings
</success_criteria>

<output>
After completion, create `.planning/phases/01-setup-core-directory/01-04-SUMMARY.md`
</output>
