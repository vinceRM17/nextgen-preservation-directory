---
phase: 01-setup-core-directory
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/components/listings/ListingCard.tsx
  - src/components/listings/ListingGrid.tsx
  - src/components/listings/ListingDetail.tsx
  - src/lib/queries/listings.ts
  - src/app/(public)/page.tsx
  - src/app/(public)/listings/[id]/page.tsx
  - src/app/(public)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "User can browse listing cards with name, role, specialties, and contact"
    - "User can click a listing card to view detailed profile"
    - "Listing detail page shows complete information and project portfolio"
  artifacts:
    - path: "src/components/listings/ListingCard.tsx"
      provides: "Card component displaying listing summary"
      min_lines: 40
    - path: "src/components/listings/ListingDetail.tsx"
      provides: "Full listing detail view with portfolio"
      min_lines: 60
    - path: "src/lib/queries/listings.ts"
      provides: "Database query functions"
      exports: ["getListings", "getListing"]
    - path: "src/app/(public)/page.tsx"
      provides: "Homepage with listing grid"
      contains: "ListingGrid"
  key_links:
    - from: "src/app/(public)/page.tsx"
      to: "src/lib/queries/listings.ts"
      via: "Server Component data fetching"
      pattern: "await getListings"
    - from: "src/components/listings/ListingCard.tsx"
      to: "/listings/[id]"
      via: "Next.js Link component"
      pattern: "href.*listings"
---

<objective>
Build the core browsing experience with listing cards, grid layout, and detailed profile pages using Next.js 15 Server Components.

Purpose: Enable users to discover and view preservation stakeholder information, fulfilling DIR-01 and DIR-02 requirements.
Output: Working homepage with listing cards and dynamic detail pages fetching real data from PostgreSQL.
</objective>

<execution_context>
@/Users/vincecain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vincecain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/vincecain/Projects/nextgen-preservation-directory/.planning/PROJECT.md
@/Users/vincecain/Projects/nextgen-preservation-directory/.planning/ROADMAP.md
@/Users/vincecain/Projects/nextgen-preservation-directory/.planning/STATE.md
@/Users/vincecain/Projects/nextgen-preservation-directory/.planning/phases/01-setup-core-directory/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Create database query functions for listings</name>
  <files>
    src/lib/queries/listings.ts
  </files>
  <action>
    Create src/lib/queries/listings.ts with query functions:

    `getListings()`: Returns all approved listings with basic fields (id, name, role, specialties, address, phone, email, website, image_url). Filter by status = 'approved'. Order by name ASC. Use Drizzle ORM query builder.

    `getListing(id: string)`: Returns single listing by id with all fields including projects (portfolio). Return null if not found or not approved.

    Both functions should use the database client from src/lib/db/index.ts. Export async functions that can be called from Server Components.

    Handle database connection errors gracefully (try/catch, return empty array or null).

    Per research: Server-first data fetching pattern (Pattern 1) â€” fetch in Server Components, not API routes, for faster loads and no API maintenance overhead.
  </action>
  <verify>
    Create temporary test file to call getListings() and getListing()
    Verify functions return properly typed data (Listing interface)
    Check that only approved listings are returned
  </verify>
  <done>
    Query functions created, tested, return typed data from database with proper filtering
  </done>
</task>

<task type="auto">
  <name>Create ListingCard and ListingGrid components</name>
  <files>
    src/components/listings/ListingCard.tsx
    src/components/listings/ListingGrid.tsx
  </files>
  <action>
    Create src/components/listings/ListingCard.tsx:
    - Accept listing prop (Listing type)
    - Display: name (heading), role/category, up to 3 specialties (comma-separated, "...more" if >3), phone, email, website link
    - Use shadcn/ui Card component for consistent styling
    - Entire card wrapped in Next.js Link to /listings/[id]
    - Responsive: Stack info vertically on mobile
    - Include optional image (image_url) with Next.js Image component if present
    - Truncate long text with CSS ellipsis

    Create src/components/listings/ListingGrid.tsx:
    - Accept listings prop (Listing[] type)
    - Render grid of ListingCard components
    - Responsive grid: 1 column mobile, 2 columns tablet, 3-4 columns desktop (use Tailwind grid)
    - Handle empty state: Display "No listings found" message if array is empty
    - Apply gap and padding for clean layout

    Per research: Use Next.js Image component for automatic optimization (don't hand-roll). Responsive design is UX-01 success criterion.
  </action>
  <verify>
    Create test page with sample listing data and render ListingGrid
    Check responsive behavior at mobile (375px), tablet (768px), desktop (1280px) widths
    Verify links navigate to correct listing detail URL
    Test empty state with empty array
  </verify>
  <done>
    ListingCard displays all required information, ListingGrid renders responsive grid, links work correctly
  </done>
</task>

<task type="auto">
  <name>Create listing detail page with portfolio display</name>
  <files>
    src/components/listings/ListingDetail.tsx
    src/app/(public)/listings/[id]/page.tsx
    src/app/(public)/layout.tsx
  </files>
  <action>
    Create src/components/listings/ListingDetail.tsx:
    - Accept listing prop (Listing type)
    - Display all fields: name (h1), description, role, specialties (list), contact info (phone, email, website), address
    - Portfolio section: Render projects array as cards with title, description, and image (if present)
    - Use semantic HTML: headings, lists, sections
    - Responsive: Single column on mobile, consider sidebar layout on desktop if contact info should be separate

    Create src/app/(public)/listings/[id]/page.tsx:
    - Next.js 15 App Router Server Component with dynamic route parameter
    - Call getListing(params.id)
    - If not found, call notFound() to render 404
    - Pass listing to ListingDetail component
    - Add generateMetadata() for dynamic page title and description (SEO)

    Create src/app/(public)/layout.tsx:
    - Import MainLayout from 01-02
    - Wrap children with MainLayout
    - Route group (public) ensures this layout applies to homepage and listings

    Per research: Dynamic routing with [id] folder, Server Components fetch data directly, notFound() for 404 handling.
  </action>
  <verify>
    Navigate to /listings/[some-id] and verify listing detail displays
    Test with invalid ID to confirm 404 page renders
    Check that page title in browser tab updates per listing name
    Verify portfolio section displays projects if present
  </verify>
  <done>
    Listing detail page renders complete information, portfolio displays correctly, 404 works for invalid IDs, metadata is dynamic
  </done>
</task>

</tasks>

<verification>
1. Homepage displays grid of listing cards
2. Clicking a card navigates to detail page
3. Detail page shows all listing information and projects
4. Components are responsive across mobile, tablet, desktop
5. Invalid listing IDs show 404 page
6. All TypeScript types are correct with no errors
</verification>

<success_criteria>
- ListingCard component displays name, role, specialties, and contact info
- ListingGrid renders responsive grid layout
- Listing detail page shows complete profile and project portfolio
- Server Components fetch data from database using query functions
- Dynamic routing works for /listings/[id]
- 404 handling for invalid listing IDs
</success_criteria>

<output>
After completion, create `.planning/phases/01-setup-core-directory/01-03-SUMMARY.md`
</output>
