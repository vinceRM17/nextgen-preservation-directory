---
phase: 01-setup-core-directory
plan: 05
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - package.json
  - src/components/map/MapView.tsx
  - src/components/map/ListingMarker.tsx
  - src/lib/queries/geo.ts
  - src/app/(public)/map/page.tsx
  - next.config.ts
autonomous: true

must_haves:
  truths:
    - "User can view all listings on an interactive map with clustered markers"
    - "User can click map markers to view stakeholder details"
    - "Map performs smoothly with 100+ markers on mobile"
  artifacts:
    - path: "src/components/map/MapView.tsx"
      provides: "Leaflet map with clustering"
      contains: "MarkerClusterGroup"
    - path: "src/lib/queries/geo.ts"
      provides: "PostGIS geospatial queries"
      exports: ["getListingsInBounds"]
    - path: "src/app/(public)/map/page.tsx"
      provides: "Full-screen map page"
      contains: "MapView"
  key_links:
    - from: "src/components/map/MapView.tsx"
      to: "src/lib/queries/geo.ts"
      via: "Client Component with useEffect data fetch"
      pattern: "fetch.*api/geo"
    - from: "src/components/map/ListingMarker.tsx"
      to: "/listings/[id]"
      via: "Popup with link to detail page"
      pattern: "href.*listings"
---

<objective>
Build interactive map experience with Leaflet, marker clustering, and PostGIS geospatial queries for location-based discovery.

Purpose: Enable visual geographic browsing of stakeholders, fulfilling SRCH-03 requirement and preventing map performance pitfall.
Output: Working map page displaying all approved listings with clustered markers and clickable popups.
</objective>

<execution_context>
@/Users/vincecain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vincecain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/vincecain/Projects/nextgen-preservation-directory/.planning/PROJECT.md
@/Users/vincecain/Projects/nextgen-preservation-directory/.planning/ROADMAP.md
@/Users/vincecain/Projects/nextgen-preservation-directory/.planning/STATE.md
@/Users/vincecain/Projects/nextgen-preservation-directory/.planning/phases/01-setup-core-directory/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Setup Leaflet with React and marker clustering</name>
  <files>
    package.json
    src/components/map/MapView.tsx
    src/components/map/ListingMarker.tsx
    next.config.ts
  </files>
  <action>
    Install Leaflet dependencies:
    ```bash
    npm install leaflet react-leaflet react-leaflet-cluster
    npm install -D @types/leaflet
    ```

    Update next.config.ts to handle Leaflet CSS imports (if needed for SSR issues).

    Create src/components/map/MapView.tsx as Client Component ('use client'):
    - Use dynamic imports to avoid SSR issues: `const MapContainer = dynamic(() => import('react-leaflet').then(mod => mod.MapContainer), { ssr: false })`
    - Same for TileLayer, Marker, Popup
    - Import MarkerClusterGroup from react-leaflet-cluster (also dynamic import)
    - Accept listings prop (Listing[] with latitude/longitude from PostGIS)
    - Center map on Louisville, KY: [38.2527, -85.7585]
    - Default zoom: 12
    - Use OpenStreetMap tiles: https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png
    - Render MarkerClusterGroup wrapping all ListingMarker components
    - Handle empty listings with fallback center position
    - Set map height: min-h-[500px] on mobile, h-[calc(100vh-200px)] on desktop

    Create src/components/map/ListingMarker.tsx:
    - Accept listing prop
    - Render Marker at [listing.latitude, listing.longitude]
    - Popup shows: listing name (link to /listings/[id]), role, phone
    - Use custom marker icon or default Leaflet icon

    Per research: Marker clustering from day one (Pattern 4) prevents performance collapse pitfall. Dynamic imports required for Leaflet in Next.js to avoid SSR window/document issues.
  </action>
  <verify>
    Create test page with sample listings including lat/lng coordinates
    Verify map renders with clustered markers
    Zoom in/out and verify clusters expand/collapse correctly
    Click marker popup and verify link works
    Test on mobile viewport for performance (should be smooth)
  </verify>
  <done>
    Leaflet map renders with OpenStreetMap tiles, markers are clustered, popups display correctly, no SSR errors
  </done>
</task>

<task type="auto">
  <name>Create PostGIS geospatial queries for map data</name>
  <files>
    src/lib/queries/geo.ts
    src/app/api/geo/route.ts
  </files>
  <action>
    Create src/lib/queries/geo.ts with PostGIS query functions:

    `getListingsInBounds(north, south, east, west)`:
    - Use PostGIS ST_MakeEnvelope() to create bounding box with provided bounds
    - Use ST_Within() to filter listings whose location is within envelope
    - Return id, name, role, phone, ST_X(location) as longitude, ST_Y(location) as latitude
    - Filter by status = 'approved'
    - SRID 4326 (WGS84 standard for lat/lng)

    `getAllListingsWithCoordinates()`:
    - Simple query for initial map load
    - Return same fields as getListingsInBounds
    - Use for Phase 1 (viewport filtering is optimization for later)

    Create src/app/api/geo/route.ts:
    - Next.js API route for GET requests
    - Accept bounds query params if provided
    - Call getAllListingsWithCoordinates() or getListingsInBounds() accordingly
    - Return JSON array of listings with coordinates
    - Handle errors gracefully

    Per research: PostGIS ST_MakeEnvelope and ST_Within for bounding box queries (Pattern 3). API route needed because map is client component requiring data fetch.
  </action>
  <verify>
    Test API route directly: GET /api/geo
    Verify response includes latitude and longitude for each listing
    Check that only approved listings are returned
    Test with bounds parameters if implementing viewport filtering
  </verify>
  <done>
    PostGIS queries created, API route returns listing coordinates correctly
  </done>
</task>

<task type="auto">
  <name>Create map page and integrate with navigation</name>
  <files>
    src/app/(public)/map/page.tsx
    src/components/layout/Header.tsx
  </files>
  <action>
    Create src/app/(public)/map/page.tsx:
    - Server Component that fetches initial listings data
    - Pass data to MapView client component
    - Full-width layout (no max-width container for map)
    - Include page title: "Map View - Preservation Directory"
    - Add optional search/filter sidebar (or defer to future enhancement)

    Update src/components/layout/Header.tsx:
    - Add "Map" link to navigation pointing to /map
    - Ensure link is accessible on mobile menu

    Add metadata to map page for SEO:
    ```typescript
    export const metadata = {
      title: 'Map View - NextGen Preservation Collab Directory',
      description: 'Explore Louisville preservation stakeholders on an interactive map'
    };
    ```

    Per research: Mobile map responsiveness is critical (Pitfall 6). Use percentage-based heights, test on real devices.
  </action>
  <verify>
    Navigate to /map and verify full map displays
    Check that markers load from database
    Verify Header "Map" link navigates correctly
    Test mobile responsiveness: map fills viewport, touch gestures work
    Verify page title and meta description in browser
  </verify>
  <done>
    Map page created with full-screen map, navigation updated, mobile responsive, markers load from API
  </done>
</task>

</tasks>

<verification>
1. Map page renders Leaflet map centered on Louisville
2. Markers display for all approved listings with coordinates
3. Markers are clustered at various zoom levels
4. Clicking marker popup shows listing info and link
5. Map is responsive and performs smoothly on mobile
6. Navigation includes Map link in Header
7. No SSR errors with Leaflet (dynamic imports working)
</verification>

<success_criteria>
- Leaflet map configured with OpenStreetMap tiles
- Marker clustering implemented using react-leaflet-cluster
- PostGIS queries return listings with coordinates via API route
- Map page displays interactive map with clickable markers
- Mobile responsive with smooth performance
- Map link added to site navigation
</success_criteria>

<output>
After completion, create `.planning/phases/01-setup-core-directory/01-05-SUMMARY.md`
</output>
