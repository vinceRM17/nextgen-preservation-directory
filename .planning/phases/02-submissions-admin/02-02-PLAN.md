---
phase: 02-submissions-admin
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/middleware.ts
  - src/app/layout.tsx
  - src/app/(admin)/layout.tsx
  - src/app/(admin)/page.tsx
  - src/app/sign-in/[[...sign-in]]/page.tsx
  - src/app/sign-up/[[...sign-up]]/page.tsx
  - .env.example
autonomous: false
user_setup:
  - service: clerk
    why: "Admin authentication for moderation dashboard"
    env_vars:
      - name: NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
        source: "Clerk Dashboard (clerk.com) -> Your Application -> API Keys"
      - name: CLERK_SECRET_KEY
        source: "Clerk Dashboard (clerk.com) -> Your Application -> API Keys"
    dashboard_config:
      - task: "Create a Clerk application"
        location: "clerk.com -> Dashboard -> Create Application"
      - task: "Note: No special configuration needed for MVP. Default email/password auth is sufficient."

must_haves:
  truths:
    - "Admin routes under /admin are protected and require authentication"
    - "Public routes (/, /listings, /submit, /map) remain accessible without login"
    - "Collab staff can sign in at /sign-in and access admin dashboard"
    - "Admin layout has navigation sidebar with links to pending queue and listings management"
  artifacts:
    - path: "src/middleware.ts"
      provides: "Clerk route protection middleware"
      contains: "clerkMiddleware"
    - path: "src/app/(admin)/layout.tsx"
      provides: "Admin layout with sidebar navigation"
      contains: "AdminLayout"
    - path: "src/app/(admin)/page.tsx"
      provides: "Admin dashboard home page"
      contains: "AdminDashboard"
  key_links:
    - from: "src/middleware.ts"
      to: "@clerk/nextjs/server"
      via: "clerkMiddleware with createRouteMatcher"
      pattern: "clerkMiddleware.*createRouteMatcher"
    - from: "src/app/layout.tsx"
      to: "@clerk/nextjs"
      via: "ClerkProvider wrapping entire app"
      pattern: "ClerkProvider"
---

<objective>
Set up Clerk authentication, route protection middleware, and admin layout shell with navigation.

Purpose: Admin features (moderation queue, listing CRUD) all require authentication. Setting up Clerk middleware and admin layout first creates the protected shell that subsequent plans fill with functionality.

Output: Working sign-in/sign-up flow, protected /admin routes, admin layout with sidebar navigation to pending queue and listings management.
</objective>

<execution_context>
@/Users/vincecain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vincecain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-submissions-admin/02-RESEARCH.md

Key existing patterns:
- App uses route groups: (public) for MainLayout pages
- Root layout at src/app/layout.tsx contains html/body with global fonts
- Dark slate-900 theme throughout
- No middleware.ts exists yet
- Fonts: Oswald (headings), Lato (body), Inter (fallback)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Clerk and configure middleware with route protection</name>
  <files>
    package.json
    src/middleware.ts
    .env.example
  </files>
  <action>
1. Install @clerk/nextjs:
```bash
npm install @clerk/nextjs
```

2. Update `.env.example` to add Clerk environment variables:
```
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...
NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
```

3. Create `src/middleware.ts` with Clerk route protection:

```typescript
import { clerkMiddleware, createRouteMatcher } from '@clerk/nextjs/server'

// Public routes that do NOT require authentication
const isPublicRoute = createRouteMatcher([
  '/',
  '/listings(.*)',
  '/map(.*)',
  '/submit(.*)',
  '/sign-in(.*)',
  '/sign-up(.*)',
  '/api/webhooks/(.*)',
  '/sitemap.xml',
  '/robots.txt',
])

export default clerkMiddleware(async (auth, request) => {
  if (!isPublicRoute(request)) {
    await auth.protect()
  }
})

export const config = {
  matcher: [
    // Skip Next.js internals and static files
    '/((?!_next|[^?]*\\.(?:html?|css|js(?!on)|jpe?g|webp|png|gif|svg|ttf|woff2?|ico|csv|docx?|xlsx?|zip|webmanifest)).*)',
    // Always run for API routes
    '/(api|trpc)(.*)',
  ],
}
```

Key decisions:
- All existing public routes (/, /listings, /map) remain public
- New /submit route is public (anyone can submit)
- /admin routes are protected (not in public matcher = requires auth)
- Webhook routes exempted for future use
  </action>
  <verify>
Verify `src/middleware.ts` exists and TypeScript compiles: `npx tsc --noEmit`. Check package.json includes @clerk/nextjs.
  </verify>
  <done>
@clerk/nextjs installed. Middleware protects /admin routes while keeping public routes accessible. Environment variables documented in .env.example.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wrap app with ClerkProvider and create sign-in/sign-up pages</name>
  <files>
    src/app/layout.tsx
    src/app/sign-in/[[...sign-in]]/page.tsx
    src/app/sign-up/[[...sign-up]]/page.tsx
  </files>
  <action>
1. Edit `src/app/layout.tsx` to wrap the entire app with `ClerkProvider`:

```typescript
import { ClerkProvider } from '@clerk/nextjs'
// ... existing imports

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <ClerkProvider>
      <html lang="en">
        <body className={/* existing font classes */}>
          {children}
        </body>
      </html>
    </ClerkProvider>
  )
}
```

Keep ALL existing content (fonts, metadata, etc). Only add ClerkProvider wrapping.

2. Create `src/app/sign-in/[[...sign-in]]/page.tsx`:
```typescript
import { SignIn } from '@clerk/nextjs'

export default function SignInPage() {
  return (
    <div className="flex min-h-screen items-center justify-center bg-slate-950">
      <SignIn />
    </div>
  )
}
```

3. Create `src/app/sign-up/[[...sign-up]]/page.tsx`:
```typescript
import { SignUp } from '@clerk/nextjs'

export default function SignUpPage() {
  return (
    <div className="flex min-h-screen items-center justify-center bg-slate-950">
      <SignUp />
    </div>
  )
}
```

Note: The [[...sign-in]] catch-all route is required by Clerk for multi-step auth flows. The dark bg-slate-950 background matches the existing app theme.
  </action>
  <verify>
Verify all three files exist. Run `npx tsc --noEmit` to check compilation. Verify ClerkProvider wraps the app in root layout.
  </verify>
  <done>
Root layout wraps app with ClerkProvider. Sign-in and sign-up pages exist with Clerk components and dark theme styling.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create admin layout shell with sidebar navigation</name>
  <files>
    src/app/(admin)/layout.tsx
    src/app/(admin)/page.tsx
  </files>
  <action>
1. Create `src/app/(admin)/layout.tsx` — Admin layout with sidebar navigation:

```typescript
import { auth, currentUser } from '@clerk/nextjs/server'
import { redirect } from 'next/navigation'
import Link from 'next/link'

export default async function AdminLayout({ children }: { children: React.ReactNode }) {
  const { userId } = await auth()

  if (!userId) {
    redirect('/sign-in')
  }

  const user = await currentUser()

  return (
    <div className="flex min-h-screen bg-slate-950">
      {/* Sidebar */}
      <aside className="w-64 border-r border-slate-800 bg-slate-900 p-6">
        <div className="mb-8">
          <Link href="/admin" className="text-lg font-bold text-slate-50 font-heading">
            Admin Dashboard
          </Link>
          <p className="mt-1 text-sm text-slate-400">
            {user?.emailAddresses?.[0]?.emailAddress ?? 'Admin'}
          </p>
        </div>
        <nav className="space-y-2">
          <Link
            href="/admin"
            className="flex items-center gap-3 rounded-md px-3 py-2 text-sm text-slate-300 hover:bg-slate-800 hover:text-slate-50 transition-colors"
          >
            {/* Inline SVG: Dashboard icon */}
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
            Dashboard
          </Link>
          <Link
            href="/admin/pending"
            className="flex items-center gap-3 rounded-md px-3 py-2 text-sm text-slate-300 hover:bg-slate-800 hover:text-slate-50 transition-colors"
          >
            {/* Inline SVG: Clock icon for pending */}
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            Pending Submissions
          </Link>
          <Link
            href="/admin/listings"
            className="flex items-center gap-3 rounded-md px-3 py-2 text-sm text-slate-300 hover:bg-slate-800 hover:text-slate-50 transition-colors"
          >
            {/* Inline SVG: List icon */}
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>
            All Listings
          </Link>
        </nav>
        <div className="mt-auto pt-6 border-t border-slate-800 mt-8">
          <Link
            href="/"
            className="flex items-center gap-3 rounded-md px-3 py-2 text-sm text-slate-400 hover:bg-slate-800 hover:text-slate-50 transition-colors"
          >
            {/* Inline SVG: Arrow left */}
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
            Back to Directory
          </Link>
        </div>
      </aside>
      {/* Main content area */}
      <main className="flex-1 p-8">
        {children}
      </main>
    </div>
  )
}
```

2. Create `src/app/(admin)/page.tsx` — Admin dashboard home with summary stats (placeholder counts for now):

```typescript
import { db } from '@/lib/db'
import { listings, submissions } from '@/lib/db/schema'
import { eq, count } from 'drizzle-orm'

export default async function AdminDashboard() {
  // Fetch summary counts
  const [pendingCount] = await db
    .select({ count: count() })
    .from(submissions)
    .where(eq(submissions.status, 'pending'))

  const [approvedCount] = await db
    .select({ count: count() })
    .from(listings)
    .where(eq(listings.status, 'approved'))

  const [totalListings] = await db
    .select({ count: count() })
    .from(listings)

  return (
    <div>
      <h1 className="text-2xl font-bold text-slate-50 font-heading mb-8">
        Admin Dashboard
      </h1>
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        {/* Pending submissions card */}
        <div className="rounded-lg border border-slate-800 bg-slate-900 p-6">
          <p className="text-sm text-slate-400">Pending Submissions</p>
          <p className="text-3xl font-bold text-yellow-400 mt-2">
            {pendingCount?.count ?? 0}
          </p>
        </div>
        {/* Approved listings card */}
        <div className="rounded-lg border border-slate-800 bg-slate-900 p-6">
          <p className="text-sm text-slate-400">Approved Listings</p>
          <p className="text-3xl font-bold text-green-400 mt-2">
            {approvedCount?.count ?? 0}
          </p>
        </div>
        {/* Total listings card */}
        <div className="rounded-lg border border-slate-800 bg-slate-900 p-6">
          <p className="text-sm text-slate-400">Total Listings</p>
          <p className="text-3xl font-bold text-slate-50 mt-2">
            {totalListings?.count ?? 0}
          </p>
        </div>
      </div>
    </div>
  )
}
```

IMPORTANT: The admin dashboard page queries the submissions table. If plan 02-01 has not been executed yet when this plan runs, the submissions queries will fail. The executor should handle this by either:
- Running 02-01 first (same wave but schema is foundational), or
- Using try/catch to gracefully handle missing table and show 0 counts

Add try/catch error handling around the database queries with fallback to 0 counts.

Key design decisions:
- Use inline SVG icons (consistent with Phase 1 pattern — no external icon library)
- Call auth() once in layout, not in every page (per Clerk pitfall from research)
- Sidebar is fixed-width with responsive consideration (mobile admin access is lower priority)
- Dark theme consistent with existing app
  </action>
  <verify>
Verify files exist: `src/app/(admin)/layout.tsx` and `src/app/(admin)/page.tsx`. Run `npx tsc --noEmit`. Verify admin layout imports from @clerk/nextjs/server correctly.
  </verify>
  <done>
Admin layout with sidebar navigation exists. Dashboard page shows summary stats. Routes /admin/* are protected by Clerk middleware. Layout calls auth() once and passes user info to sidebar.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. @clerk/nextjs is in package.json dependencies
3. middleware.ts exists at src/middleware.ts with clerkMiddleware
4. Root layout wraps children with ClerkProvider
5. Sign-in and sign-up pages exist with Clerk components
6. Admin layout has sidebar with links to /admin, /admin/pending, /admin/listings
7. Admin dashboard shows summary stat cards
</verification>

<success_criteria>
- Unauthenticated users are redirected to /sign-in when accessing /admin routes
- Public routes (/, /listings, /map, /submit) remain accessible without authentication
- Admin layout renders with sidebar navigation and main content area
- Dashboard displays count cards (even if 0)
</success_criteria>

<output>
After completion, create `.planning/phases/02-submissions-admin/02-02-SUMMARY.md`
</output>
