---
phase: 02-submissions-admin
plan: 04
type: execute
wave: 3
depends_on: ["02-01", "02-03"]
files_modified:
  - package.json
  - src/app/submit/page.tsx
  - src/app/submit/actions.ts
  - src/app/submit/form.tsx
  - src/app/submit/success/page.tsx
autonomous: true

must_haves:
  truths:
    - "Stakeholder can fill out and submit a listing form with name, email, category, specialties, address, and optional fields"
    - "Address is geocoded and validated within Louisville bounds on submission"
    - "System checks for duplicate listings and shows warning if similar names found"
    - "Successful submission shows confirmation message"
    - "Invalid form data shows field-level error messages"
  artifacts:
    - path: "src/app/submit/page.tsx"
      provides: "Server component wrapper for submission form"
      contains: "SubmissionForm"
    - path: "src/app/submit/form.tsx"
      provides: "Client component with React Hook Form + Zod validation"
      contains: "useForm"
    - path: "src/app/submit/actions.ts"
      provides: "Server Action for form submission with geocoding and duplicate detection"
      exports: ["submitListing"]
  key_links:
    - from: "src/app/submit/actions.ts"
      to: "src/lib/geocoding/client.ts"
      via: "geocodeAddress() call for address validation"
      pattern: "geocodeAddress"
    - from: "src/app/submit/actions.ts"
      to: "src/lib/duplicate-detection/similarity.ts"
      via: "findSimilarListings() call for duplicate flagging"
      pattern: "findSimilarListings"
    - from: "src/app/submit/actions.ts"
      to: "src/lib/db/schema.ts"
      via: "db.insert(submissions) for saving submission"
      pattern: "db\\.insert.*submissions"
    - from: "src/app/submit/form.tsx"
      to: "src/lib/validation/submission.ts"
      via: "zodResolver with submissionSchema"
      pattern: "zodResolver.*submissionSchema"
---

<objective>
Build the public submission form where stakeholders can submit their listing for admin review, with address geocoding and duplicate detection integrated into the server action.

Purpose: This is the core public-facing feature of Phase 2. Stakeholders need a simple, single-page form to submit their information. The server action validates data, geocodes the address, checks for duplicates, and saves to the submissions table.

Output: Working /submit page with validated form, server-side geocoding, duplicate detection, and success confirmation.
</objective>

<execution_context>
@/Users/vincecain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vincecain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-submissions-admin/02-RESEARCH.md
@.planning/phases/02-submissions-admin/02-01-SUMMARY.md
@.planning/phases/02-submissions-admin/02-03-SUMMARY.md

Key dependencies from prior plans:
- submissions table in src/lib/db/schema.ts (from 02-01)
- submissionSchema in src/lib/validation/submission.ts (from 02-01)
- categoryValues array exported from submission validation (from 02-01)
- geocodeAddress() in src/lib/geocoding/client.ts (from 02-03)
- findSimilarListings() in src/lib/duplicate-detection/similarity.ts (from 02-03)
- UI components: Input, Select, Textarea, Button, Label (from 02-01 + existing)
- Form component for React Hook Form integration (from 02-01)

Research guidance:
- Single-page form with logical grouping (not multi-step)
- React Hook Form + Zod for client-side validation
- Server Action with useActionState for server-side processing
- Geocode only on submission (not on field change)
- Defer image uploads to Phase 3+
- Use sonner for toast notifications
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install React Hook Form and sonner, create Server Action</name>
  <files>
    package.json
    src/app/submit/actions.ts
  </files>
  <action>
1. Install required packages:
```bash
npm install react-hook-form @hookform/resolvers sonner
```

2. Create `src/app/submit/actions.ts` — Server Action for processing submissions:

```typescript
'use server'

import { db } from '@/lib/db'
import { submissions } from '@/lib/db/schema'
import { submissionSchema } from '@/lib/validation/submission'
import { geocodeAddress } from '@/lib/geocoding/client'
import { findSimilarListings } from '@/lib/duplicate-detection/similarity'

export type SubmitState = {
  success?: boolean
  errors?: Record<string, string[]>
  message?: string
  duplicates?: Array<{ id: string; name: string; role: string; similarity: number }>
}

export async function submitListing(
  prevState: SubmitState,
  formData: FormData
): Promise<SubmitState> {
  // 1. Parse and validate form data with Zod
  const raw = {
    name: formData.get('name') as string,
    organization: formData.get('organization') as string,
    email: formData.get('email') as string,
    phone: formData.get('phone') as string,
    role: formData.get('role') as string,
    specialties: formData.getAll('specialties') as string[],
    website: formData.get('website') as string,
    description: formData.get('description') as string,
    address: formData.get('address') as string,
  }

  const validated = submissionSchema.safeParse(raw)

  if (!validated.success) {
    return {
      errors: validated.error.flatten().fieldErrors as Record<string, string[]>,
      message: 'Please fix the errors below.',
    }
  }

  const { name, organization, email, phone, role, specialties, website, description, address } = validated.data

  try {
    // 2. Geocode address with Mapbox
    const geocodeResult = await geocodeAddress(address)

    if (!geocodeResult.success) {
      return {
        errors: { address: [geocodeResult.error] },
        message: 'Address validation failed.',
      }
    }

    const { coordinates, formattedAddress } = geocodeResult.data

    // 3. Check for potential duplicates
    const similarListings = await findSimilarListings({ name, threshold: 0.4 })

    // If high-confidence duplicate found (>70%), flag it but still save
    const highConfidenceDupe = similarListings.find(s => s.similarity > 0.7)

    // 4. Insert into submissions table
    await db.insert(submissions).values({
      name,
      organization: organization || null,
      email,
      phone: phone || null,
      role,
      specialties,
      website: website || null,
      description: description || null,
      address: formattedAddress,
      formattedAddress,
      location: `POINT(${coordinates.x} ${coordinates.y})`,
      status: 'pending',
      duplicateOf: highConfidenceDupe?.id ?? null,
      similarityScore: highConfidenceDupe ? String(highConfidenceDupe.similarity) : null,
    })

    // 5. Return success (with duplicate warning if applicable)
    if (similarListings.length > 0) {
      return {
        success: true,
        duplicates: similarListings,
        message: 'Submission received! Note: We found similar existing listings. An admin will review your submission.',
      }
    }

    return {
      success: true,
      message: 'Submission received! An admin will review your listing and you will be notified when it is approved.',
    }
  } catch (error) {
    console.error('Submission error:', error)
    return {
      message: 'An unexpected error occurred. Please try again.',
    }
  }
}
```

Key decisions:
- Zod validation happens server-side (single source of truth, can't be bypassed)
- Client-side validation also happens via React Hook Form (for instant UX feedback)
- Geocoding runs server-side only (never expose Mapbox token to client)
- Duplicates are flagged but submission still saves (admin makes final call)
- Location stored as WKT string matching existing PostGIS pattern from schema
- Return discriminated state for clean UI rendering
  </action>
  <verify>
Run `npx tsc --noEmit`. Verify package.json has react-hook-form, @hookform/resolvers, sonner. Verify actions.ts exports submitListing.
  </verify>
  <done>
Server Action validates form data with Zod, geocodes address with Mapbox, checks duplicates with pg_trgm, and inserts submission into database. Returns structured state for UI feedback.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create submission form page with client-side validation</name>
  <files>
    src/app/submit/page.tsx
    src/app/submit/form.tsx
    src/app/submit/success/page.tsx
  </files>
  <action>
1. Create `src/app/submit/form.tsx` — Client component with React Hook Form:

This is a 'use client' component that provides instant client-side validation before submission.

The form has three logical sections with clear headings:
- **Contact Information**: name, organization (optional), email, phone (optional)
- **Professional Details**: role/category dropdown, specialties checkboxes, website (optional), description (optional)
- **Location**: address input

For specialties, use a list of common preservation specialties as checkboxes:
```
const SPECIALTIES = [
  'Historic Renovation', 'Masonry Restoration', 'Woodwork', 'Metalwork',
  'Plaster & Stucco', 'Window Restoration', 'Roofing (Historic)',
  'Electrical (Historic)', 'Plumbing (Historic)', 'HVAC (Historic)',
  'Tax Credit Projects', 'Community Development', 'Zoning & Compliance',
  'Architectural Design', 'Structural Assessment', 'Property Management',
  'Grant Writing', 'Historic Research', 'Education & Training',
  'Sustainability', 'ADA Compliance', 'Lead & Asbestos Remediation',
]
```

Use React Hook Form with zodResolver for client-side validation:
```typescript
const form = useForm<SubmissionFormData>({
  resolver: zodResolver(submissionSchema),
  defaultValues: { /* all empty strings/arrays */ },
})
```

Use `useActionState` from React to handle server action:
```typescript
const [state, formAction, isPending] = useActionState(submitListing, {})
```

When state.success is true, redirect to /submit/success or show inline success message.

When state.duplicates exists, show a warning section with similar listing names and similarity percentages.

When state.errors exists, map server errors to form fields for display.

Use sonner `toast()` for transient feedback (success/error messages).

Form styling:
- Max width container (max-w-2xl mx-auto)
- Section headers with border-b border-slate-800 and padding
- Required fields marked with asterisk and text-red-500
- Dark theme: bg-slate-900 cards for sections, slate-800 borders
- Submit button: primary style with loading spinner when isPending
- Disabled button while isPending to prevent double submission

IMPORTANT: For the specialties checkboxes, use native HTML checkboxes with custom styling (not the Form component wrapper, which adds complexity). Each checkbox appends/removes from the specialties array in form state.

For category selection, use the existing Select component from src/components/ui/select.tsx with categoryValues from the validation schema.

2. Create `src/app/submit/page.tsx` — Server component wrapper:
```typescript
import { SubmissionForm } from './form'

export const metadata = {
  title: 'Submit a Listing | NextGen Preservation Directory',
  description: 'Submit your organization or business for listing in the Louisville historic preservation directory.',
}

export default function SubmitPage() {
  return (
    <div className="min-h-screen bg-slate-950 py-12 px-4">
      <div className="max-w-2xl mx-auto">
        <h1 className="text-3xl font-bold text-slate-50 font-heading mb-2">
          Submit a Listing
        </h1>
        <p className="text-slate-400 mb-8">
          Add your organization to the Louisville Historic Preservation Directory.
          All submissions are reviewed by an admin before being published.
        </p>
        <SubmissionForm />
      </div>
    </div>
  )
}
```

3. Create `src/app/submit/success/page.tsx` — Success confirmation page:
```typescript
import Link from 'next/link'

export const metadata = {
  title: 'Submission Received | NextGen Preservation Directory',
}

export default function SubmitSuccessPage() {
  return (
    <div className="min-h-screen bg-slate-950 flex items-center justify-center px-4">
      <div className="max-w-md text-center">
        <div className="mb-6">
          {/* Green checkmark SVG */}
          <svg className="mx-auto h-16 w-16 text-green-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
        </div>
        <h1 className="text-2xl font-bold text-slate-50 font-heading mb-4">
          Submission Received!
        </h1>
        <p className="text-slate-400 mb-8">
          Thank you for submitting your listing. An admin will review your
          submission and it will appear in the directory once approved.
        </p>
        <div className="flex gap-4 justify-center">
          <Link
            href="/"
            className="rounded-md bg-slate-50 px-4 py-2 text-sm font-medium text-slate-900 hover:bg-slate-200 transition-colors"
          >
            Browse Directory
          </Link>
          <Link
            href="/submit"
            className="rounded-md border border-slate-700 px-4 py-2 text-sm font-medium text-slate-50 hover:bg-slate-800 transition-colors"
          >
            Submit Another
          </Link>
        </div>
      </div>
    </div>
  )
}
```

Key UX decisions:
- Single page form (not multi-step) per research recommendation
- Three logical sections with visual separation
- Client-side validation for instant feedback (React Hook Form + Zod)
- Server-side validation as source of truth (Server Action + Zod)
- Duplicate warnings shown inline (not blocking)
- Success redirects to dedicated page
- No image upload (deferred to Phase 3+)
  </action>
  <verify>
Run `npx tsc --noEmit`. Verify all files exist. Check that form.tsx is a 'use client' component importing React Hook Form. Check that page.tsx imports SubmissionForm. Verify success page has navigation links.
  </verify>
  <done>
Complete /submit flow: server-wrapped page, client form with RHF+Zod validation, server action with geocoding and duplicate detection, success confirmation page. Specialties use checkboxes, category uses dropdown. Dark theme, responsive layout.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. /submit page renders the submission form
3. Form validates required fields (name, email, role, specialties, address) client-side
4. Server action validates, geocodes, checks duplicates, and saves to submissions table
5. Success page displays after successful submission
6. Duplicate warnings display when similar listings exist
7. react-hook-form, @hookform/resolvers, sonner in package.json
</verification>

<success_criteria>
- Submitting valid form data creates a new row in submissions table with status='pending'
- Invalid data shows field-level error messages without page reload
- Address outside Louisville shows bounds error
- Similar existing listings trigger duplicate warning
- Successful submission redirects to success page
</success_criteria>

<output>
After completion, create `.planning/phases/02-submissions-admin/02-04-SUMMARY.md`
</output>
