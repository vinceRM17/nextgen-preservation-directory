---
phase: 02-submissions-admin
plan: 06
type: execute
wave: 4
depends_on: ["02-02", "02-05"]
files_modified:
  - src/app/(admin)/listings/page.tsx
  - src/app/(admin)/listings/actions.ts
  - src/app/(admin)/listings/new/page.tsx
  - src/app/(admin)/listings/[id]/edit/page.tsx
  - src/components/admin/listing-table.tsx
  - src/components/admin/listing-form.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view all listings (any status) in a table at /admin/listings"
    - "Admin can create a new listing directly via /admin/listings/new"
    - "Admin can edit any existing listing via /admin/listings/[id]/edit"
    - "Admin can delete a listing from the listings table"
    - "Changes to listings are immediately reflected in the directory"
  artifacts:
    - path: "src/app/(admin)/listings/page.tsx"
      provides: "All listings table page"
      contains: "ListingTable"
    - path: "src/app/(admin)/listings/actions.ts"
      provides: "Server Actions for listing CRUD"
      exports: ["createListing", "updateListing", "deleteListing"]
    - path: "src/components/admin/listing-form.tsx"
      provides: "Reusable form for create and edit listing"
      contains: "ListingForm"
  key_links:
    - from: "src/app/(admin)/listings/actions.ts"
      to: "src/lib/db/schema.ts"
      via: "db.insert/update/delete on listings table"
      pattern: "db\\.(insert|update|delete).*listings"
    - from: "src/components/admin/listing-form.tsx"
      to: "src/lib/validation/submission.ts"
      via: "adminListingSchema for form validation"
      pattern: "adminListingSchema"
---

<objective>
Build the admin listing management pages: view all listings table, create new listing form, edit existing listing form, and delete functionality.

Purpose: Admins need direct CRUD access to listings beyond the submission approval flow. This enables creating listings manually (for stakeholders who contact Collab directly), editing approved listings (fixing typos, updating info), and removing outdated listings.

Output: /admin/listings table with all listings, /admin/listings/new create form, /admin/listings/[id]/edit form, delete confirmation.
</objective>

<execution_context>
@/Users/vincecain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vincecain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-submissions-admin/02-RESEARCH.md
@.planning/phases/02-submissions-admin/02-02-SUMMARY.md
@.planning/phases/02-submissions-admin/02-05-SUMMARY.md

Key dependencies:
- Admin layout with sidebar at src/app/(admin)/layout.tsx (from 02-02)
- TanStack Table installed (from 02-05)
- UI components: Table, Button, Badge, Dialog, Form, Input, Select, Textarea (from 02-01)
- adminListingSchema in src/lib/validation/submission.ts (from 02-01)
- listings table schema (from Phase 1)
- React Hook Form + @hookform/resolvers installed (from 02-04)

Patterns from 02-05 (pending table):
- Server component fetches data, passes serialized to client table component
- Server Actions with auth checks and revalidatePath
- Column definitions with inline action buttons
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create listing CRUD Server Actions</name>
  <files>
    src/app/(admin)/listings/actions.ts
  </files>
  <action>
Create `src/app/(admin)/listings/actions.ts` with three server actions:

1. **createListing** — Creates a new listing directly (admin bypass of submission flow):
```typescript
'use server'

import { db } from '@/lib/db'
import { listings } from '@/lib/db/schema'
import { adminListingSchema } from '@/lib/validation/submission'
import { auth } from '@clerk/nextjs/server'
import { revalidatePath } from 'next/cache'
import { redirect } from 'next/navigation'

export async function createListing(prevState: any, formData: FormData) {
  const { userId } = await auth()
  if (!userId) throw new Error('Unauthorized')

  const raw = {
    name: formData.get('name'),
    description: formData.get('description'),
    role: formData.get('role'),
    specialties: formData.getAll('specialties'),
    address: formData.get('address'),
    phone: formData.get('phone'),
    email: formData.get('email'),
    website: formData.get('website'),
    imageUrl: formData.get('imageUrl'),
    status: formData.get('status') || 'approved',
  }

  const validated = adminListingSchema.safeParse(raw)

  if (!validated.success) {
    return {
      errors: validated.error.flatten().fieldErrors,
      message: 'Validation failed.',
    }
  }

  const data = validated.data

  await db.insert(listings).values({
    name: data.name,
    description: data.description || null,
    role: data.role,
    specialties: data.specialties,
    address: data.address || null,
    phone: data.phone || null,
    email: data.email || null,
    website: data.website || null,
    imageUrl: data.imageUrl || null,
    status: data.status || 'approved',
  })

  revalidatePath('/admin/listings')
  revalidatePath('/')
  redirect('/admin/listings')
}
```

2. **updateListing** — Updates an existing listing:
```typescript
export async function updateListing(listingId: string, prevState: any, formData: FormData) {
  const { userId } = await auth()
  if (!userId) throw new Error('Unauthorized')

  // Same validation as createListing
  // Use db.update().set().where(eq(listings.id, listingId))
  // revalidatePath on /admin/listings, /, and /listings/[id]
  // redirect to /admin/listings
}
```

Use `.bind(null, listingId)` pattern when calling from client to pass the listing ID.

3. **deleteListing** — Deletes a listing:
```typescript
export async function deleteListing(listingId: string) {
  const { userId } = await auth()
  if (!userId) throw new Error('Unauthorized')

  await db.delete(listings).where(eq(listings.id, listingId))

  revalidatePath('/admin/listings')
  revalidatePath('/')

  return { success: true }
}
```

All actions: auth check, Zod validation (where applicable), database operation, path revalidation. Return plain objects.
  </action>
  <verify>
Run `npx tsc --noEmit`. Verify actions.ts exports createListing, updateListing, deleteListing.
  </verify>
  <done>
Three Server Actions: createListing (validates + inserts), updateListing (validates + updates), deleteListing (deletes). All have auth checks and revalidate affected paths.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create listing table page and reusable listing form</name>
  <files>
    src/app/(admin)/listings/page.tsx
    src/components/admin/listing-table.tsx
    src/components/admin/listing-form.tsx
  </files>
  <action>
1. Create `src/components/admin/listing-form.tsx` — Reusable form for create and edit:

This is a 'use client' component using React Hook Form + zodResolver with adminListingSchema. It receives optional `defaultValues` prop for edit mode.

```typescript
'use client'

// Props: { action: server action, defaultValues?: existing listing data, submitLabel: string }
```

Form sections (matching submission form structure):
- Name, description, email, phone, website, imageUrl
- Role dropdown (category), specialties checkboxes
- Address field
- Status dropdown (draft/pending/approved/rejected) — admin only, not in public form

Use same SPECIALTIES array as submission form. Import categoryValues from validation.

Submit button shows loading state. Form errors display per-field from server action response.

For edit mode, populate all fields with existing listing data via defaultValues.

2. Create `src/components/admin/listing-table.tsx` — Client component with TanStack Table:

Follow exact same pattern as pending-table.tsx from 02-05 but for all listings:

Columns: Name, Category (badge), Status (color-coded badge: green=approved, yellow=pending, red=rejected, gray=draft), Email, Updated date, Actions (Edit link + Delete button).

Status badge colors:
- approved: bg-green-900 text-green-200
- pending: bg-yellow-900 text-yellow-200
- rejected: bg-red-900 text-red-200
- draft: bg-slate-700 text-slate-300

Delete button opens confirmation dialog (same inline dialog pattern as reject in 02-05).

Edit button links to /admin/listings/[id]/edit.

Add "New Listing" button above the table that links to /admin/listings/new.

3. Create `src/app/(admin)/listings/page.tsx` — Server component:

```typescript
import { db } from '@/lib/db'
import { listings } from '@/lib/db/schema'
import { desc } from 'drizzle-orm'
import { ListingTable } from '@/components/admin/listing-table'
import Link from 'next/link'

export default async function ListingsPage() {
  const allListings = await db
    .select({
      id: listings.id,
      name: listings.name,
      role: listings.role,
      email: listings.email,
      status: listings.status,
      updatedAt: listings.updatedAt,
    })
    .from(listings)
    .orderBy(desc(listings.updatedAt))

  const serialized = allListings.map(l => ({
    ...l,
    email: l.email || '',
    updatedAt: l.updatedAt.toISOString(),
  }))

  return (
    <div>
      <div className="flex items-center justify-between mb-8">
        <div>
          <h1 className="text-2xl font-bold text-slate-50 font-heading">All Listings</h1>
          <p className="text-sm text-slate-400 mt-1">{allListings.length} total listings</p>
        </div>
        <Link
          href="/admin/listings/new"
          className="rounded-md bg-slate-50 px-4 py-2 text-sm font-medium text-slate-900 hover:bg-slate-200 transition-colors"
        >
          + New Listing
        </Link>
      </div>
      <ListingTable data={serialized} />
    </div>
  )
}
```

Serialize dates to ISO strings before passing to client component.
  </action>
  <verify>
Run `npx tsc --noEmit`. Verify all files exist. Check ListingTable uses useReactTable. Check listing-form.tsx accepts defaultValues prop.
  </verify>
  <done>
All listings table shows every listing with status badges and edit/delete actions. Reusable ListingForm component works for both create and edit. New Listing button links to create page.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create new listing and edit listing pages</name>
  <files>
    src/app/(admin)/listings/new/page.tsx
    src/app/(admin)/listings/[id]/edit/page.tsx
  </files>
  <action>
1. Create `src/app/(admin)/listings/new/page.tsx`:

```typescript
import { ListingForm } from '@/components/admin/listing-form'
import { createListing } from '../actions'

export default function NewListingPage() {
  return (
    <div>
      <h1 className="text-2xl font-bold text-slate-50 font-heading mb-8">
        Create New Listing
      </h1>
      <div className="max-w-2xl">
        <ListingForm action={createListing} submitLabel="Create Listing" />
      </div>
    </div>
  )
}
```

2. Create `src/app/(admin)/listings/[id]/edit/page.tsx`:

```typescript
import { db } from '@/lib/db'
import { listings } from '@/lib/db/schema'
import { eq } from 'drizzle-orm'
import { notFound } from 'next/navigation'
import { ListingForm } from '@/components/admin/listing-form'
import { updateListing } from '../../actions'

export default async function EditListingPage({
  params,
}: {
  params: Promise<{ id: string }>
}) {
  const { id } = await params

  const [listing] = await db
    .select()
    .from(listings)
    .where(eq(listings.id, id))
    .limit(1)

  if (!listing) {
    notFound()
  }

  // Create bound action with listing ID
  const boundUpdateListing = updateListing.bind(null, id)

  // Convert listing data to form-compatible defaultValues
  const defaultValues = {
    name: listing.name,
    description: listing.description || '',
    role: listing.role,
    specialties: listing.specialties || [],
    address: listing.address || '',
    phone: listing.phone || '',
    email: listing.email || '',
    website: listing.website || '',
    imageUrl: listing.imageUrl || '',
    status: listing.status,
  }

  return (
    <div>
      <h1 className="text-2xl font-bold text-slate-50 font-heading mb-8">
        Edit Listing: {listing.name}
      </h1>
      <div className="max-w-2xl">
        <ListingForm
          action={boundUpdateListing}
          defaultValues={defaultValues}
          submitLabel="Save Changes"
        />
      </div>
    </div>
  )
}
```

Key decisions:
- Use Next.js 15 async params pattern: `params: Promise<{ id: string }>` with `await params`
- Use `.bind(null, id)` to pass listing ID to the updateListing server action
- Convert null values to empty strings for form defaultValues (form fields expect strings)
- notFound() if listing doesn't exist
- Max width container for form readability
  </action>
  <verify>
Run `npx tsc --noEmit`. Verify both pages exist. Check edit page fetches listing by ID and passes defaultValues to form. Check new page uses createListing action.
  </verify>
  <done>
New listing page at /admin/listings/new with empty form. Edit listing page at /admin/listings/[id]/edit with pre-populated form. Both use reusable ListingForm component. Edit uses .bind() for action with ID.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. /admin/listings shows table with all listings
3. /admin/listings/new renders empty form that creates listing on submit
4. /admin/listings/[id]/edit renders pre-filled form that updates listing on submit
5. Delete action removes listing and refreshes table
6. Status badges are color-coded (green/yellow/red/gray)
7. All actions have auth checks
</verification>

<success_criteria>
- Admin can create a new listing via /admin/listings/new and it appears in the directory
- Admin can edit any listing via /admin/listings/[id]/edit and changes are immediately visible
- Admin can delete a listing and it disappears from the directory
- Listings table shows all listings regardless of status
- Form validation prevents saving invalid data
</success_criteria>

<output>
After completion, create `.planning/phases/02-submissions-admin/02-06-SUMMARY.md`
</output>
