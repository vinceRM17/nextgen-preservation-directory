---
phase: 02-submissions-admin
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/schema.ts
  - src/lib/validation/submission.ts
  - src/types/index.ts
  - drizzle/migrations/0002_add_submissions_table.sql
  - drizzle/migrations/0003_add_trigram_indexes.sql
  - src/components/ui/textarea.tsx
  - src/components/ui/form.tsx
  - src/components/ui/label.tsx
  - src/components/ui/button.tsx
  - src/components/ui/checkbox.tsx
  - src/components/ui/dialog.tsx
  - src/components/ui/badge.tsx
  - src/components/ui/table.tsx
autonomous: true

must_haves:
  truths:
    - "Submissions table exists in database with pending/approved/rejected status workflow"
    - "Submission form data can be validated with Zod schema (name, email, phone, address, category, specialties)"
    - "UI components needed for forms and admin tables are available"
  artifacts:
    - path: "src/lib/db/schema.ts"
      provides: "Submissions table definition with status enum reuse"
      contains: "submissions"
    - path: "src/lib/validation/submission.ts"
      provides: "Zod schemas for submission form and admin actions"
      exports: ["submissionSchema", "adminActionSchema"]
    - path: "src/components/ui/form.tsx"
      provides: "Form primitives for React Hook Form integration"
      exports: ["Form", "FormField", "FormItem", "FormLabel", "FormControl", "FormMessage"]
    - path: "src/components/ui/table.tsx"
      provides: "Table primitives for TanStack Table integration"
      exports: ["Table", "TableBody", "TableCell", "TableHead", "TableHeader", "TableRow"]
  key_links:
    - from: "src/lib/db/schema.ts"
      to: "src/lib/validation/submission.ts"
      via: "category enum values match between DB enum and Zod schema"
      pattern: "categoryEnum.*submissionSchema"
---

<objective>
Create the database schema extension for submissions, Zod validation schemas, and all UI components needed for Phase 2 forms and admin tables.

Purpose: Every subsequent plan in Phase 2 depends on the submissions table, validation schemas, and UI primitives. Building these first unblocks parallel work on auth (02-02) and all downstream plans.

Output: Extended database schema with submissions table, comprehensive Zod validation, and manually-created shadcn/ui components (Form, Table, Button, Textarea, Dialog, Badge, Checkbox, Label).
</objective>

<execution_context>
@/Users/vincecain/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vincecain/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-setup-core-directory/01-01-SUMMARY.md
@.planning/phases/02-submissions-admin/02-RESEARCH.md

Key constraints from Phase 1:
- shadcn/ui components MUST be manually created (npx shadcn CLI has permission issues)
- Existing UI components: card.tsx, input.tsx, select.tsx in src/components/ui/
- Existing schema: listings table with statusEnum, categoryEnum in src/lib/db/schema.ts
- Existing validation: listingSchema in src/lib/validation/listing.ts
- Existing types: Category, Listing, ListingStatus in src/types/index.ts
- Database uses Drizzle ORM with postgres-js driver
- pg_trgm extension already enabled via migration 0001
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend database schema with submissions table and trigram indexes</name>
  <files>
    src/lib/db/schema.ts
    src/types/index.ts
    drizzle/migrations/0002_add_submissions_table.sql
    drizzle/migrations/0003_add_trigram_indexes.sql
  </files>
  <action>
1. Edit `src/lib/db/schema.ts` to add a `submissions` table. The submissions table stores public form submissions before admin approval. It mirrors most listing fields but adds submission-specific metadata:

```typescript
export const submissions = pgTable('submissions', {
  id: uuid('id').defaultRandom().primaryKey(),
  // Submitter info
  name: varchar('name', { length: 255 }).notNull(),
  organization: varchar('organization', { length: 255 }),
  email: varchar('email', { length: 255 }).notNull(),
  phone: varchar('phone', { length: 20 }),
  // Professional details
  role: categoryEnum('role').notNull(),
  specialties: text('specialties').array(),
  website: varchar('website', { length: 500 }),
  description: text('description'),
  // Location
  address: varchar('address', { length: 500 }).notNull(),
  formattedAddress: varchar('formatted_address', { length: 500 }),
  location: geometry('location'),
  // Moderation
  status: statusEnum('status').default('pending').notNull(),
  adminNotes: text('admin_notes'),
  reviewedAt: timestamp('reviewed_at'),
  reviewedBy: varchar('reviewed_by', { length: 255 }),
  // Duplicate detection
  duplicateOf: uuid('duplicate_of'),
  similarityScore: varchar('similarity_score', { length: 10 }),
  // Timestamps
  submittedAt: timestamp('submitted_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
}, (table) => ({
  statusIdx: index('submissions_status_idx').on(table.status),
  submittedAtIdx: index('submissions_submitted_at_idx').on(table.submittedAt),
}));

export type Submission = typeof submissions.$inferSelect;
export type NewSubmission = typeof submissions.$inferInsert;
```

Note: Reuse the existing `statusEnum` and `categoryEnum` from the schema. Do NOT create new enums.

2. Update `src/types/index.ts` to add Submission type and admin action types:
- Add `Submission` import from schema
- Add `SubmissionStatus` type alias (same as ListingStatus)
- Add `AdminAction` type: `'approve' | 'reject' | 'edit'`

3. Create migration `drizzle/migrations/0002_add_submissions_table.sql`:
- CREATE TABLE submissions with all columns matching the Drizzle schema
- Use existing `status` and `category` enum types (already created in 0000 migration)
- Add indexes on status and submitted_at

4. Create migration `drizzle/migrations/0003_add_trigram_indexes.sql`:
- CREATE INDEX listings_name_trgm_idx ON listings USING GIN (name gin_trgm_ops);
- CREATE INDEX listings_organization_trgm_idx ON listings USING GIN (COALESCE(description, '') gin_trgm_ops);
- These GIN indexes enable fast pg_trgm similarity queries for duplicate detection (pg_trgm extension already enabled in migration 0001)

Note: The listings table does not have an `organization` column, so create the name trigram index on `name` and a second on `description` (or skip if not needed for duplicate matching). The submissions table DOES have `organization`, so also add:
- CREATE INDEX submissions_name_trgm_idx ON submissions USING GIN (name gin_trgm_ops);
  </action>
  <verify>
Run `npx drizzle-kit generate` to verify schema is valid Drizzle syntax. Check that migration SQL files exist and contain valid SQL. Verify TypeScript compilation with `npx tsc --noEmit`.
  </verify>
  <done>
Submissions table defined in schema.ts with status/category enum reuse. Migration files exist for submissions table creation and trigram indexes. TypeScript types updated. No compilation errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Zod validation schemas for submissions and admin actions</name>
  <files>
    src/lib/validation/submission.ts
  </files>
  <action>
Create `src/lib/validation/submission.ts` with the following Zod schemas:

1. **submissionSchema** — validates public submission form data:
```typescript
import { z } from 'zod';

const categoryValues = [
  'Builder', 'Craftsperson', 'Tradesperson', 'Developer', 'Investor',
  'Advocate', 'Architect', 'Government', 'Nonprofit', 'Educator',
] as const;

export const submissionSchema = z.object({
  name: z.string().min(2, 'Name must be at least 2 characters').max(255),
  organization: z.string().max(255).optional().or(z.literal('')),
  email: z.string().email('Invalid email address'),
  phone: z.string()
    .regex(/^[\d\s\-\(\)\+\.]+$/, 'Invalid phone number format')
    .min(7, 'Phone number too short')
    .max(20)
    .optional()
    .or(z.literal('')),
  role: z.enum(categoryValues),
  specialties: z.array(z.string()).min(1, 'Select at least one specialty'),
  website: z.string().url('Invalid URL').optional().or(z.literal('')),
  description: z.string().max(1000, 'Description must be under 1000 characters').optional().or(z.literal('')),
  address: z.string().min(5, 'Please enter a full address'),
});

export type SubmissionFormData = z.infer<typeof submissionSchema>;
```

2. **adminActionSchema** — validates admin moderation actions:
```typescript
export const adminActionSchema = z.object({
  submissionId: z.string().uuid(),
  action: z.enum(['approve', 'reject']),
  adminNotes: z.string().max(1000).optional(),
});

export type AdminActionData = z.infer<typeof adminActionSchema>;
```

3. **adminListingSchema** — validates admin direct listing create/edit:
```typescript
export const adminListingSchema = z.object({
  name: z.string().min(2).max(255),
  description: z.string().optional().or(z.literal('')),
  role: z.enum(categoryValues),
  specialties: z.array(z.string()).min(1),
  address: z.string().max(500).optional().or(z.literal('')),
  phone: z.string().max(20).optional().or(z.literal('')),
  email: z.string().email().optional().or(z.literal('')),
  website: z.string().url().optional().or(z.literal('')),
  imageUrl: z.string().url().optional().or(z.literal('')),
  status: z.enum(['draft', 'pending', 'approved', 'rejected']).optional(),
});

export type AdminListingData = z.infer<typeof adminListingSchema>;
```

Export all schemas and types. Keep categoryValues as a const array so it can be imported by form components for dropdown options.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify all types compile. Verify the file exports submissionSchema, adminActionSchema, adminListingSchema, and their inferred types.
  </verify>
  <done>
Three Zod schemas exist: submissionSchema for public form, adminActionSchema for moderation, adminListingSchema for admin CRUD. All export inferred TypeScript types. categoryValues array exported for form dropdowns.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create shadcn/ui components for forms and admin tables</name>
  <files>
    src/components/ui/textarea.tsx
    src/components/ui/form.tsx
    src/components/ui/label.tsx
    src/components/ui/button.tsx
    src/components/ui/checkbox.tsx
    src/components/ui/dialog.tsx
    src/components/ui/badge.tsx
    src/components/ui/table.tsx
  </files>
  <action>
Manually create shadcn/ui components following the same patterns as existing card.tsx, input.tsx, and select.tsx. Each component should use forwardRef, cn() utility, and match the dark slate theme established in Phase 1. All components are client components where needed (forms), server-compatible where possible.

1. **textarea.tsx** — Standard HTML textarea styled consistently with input.tsx. Use `React.TextareaHTMLAttributes<HTMLTextAreaElement>`, forwardRef pattern, cn() for className merging. Styling: `flex min-h-[80px] w-full rounded-md border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-400 disabled:cursor-not-allowed disabled:opacity-50`.

2. **label.tsx** — Label component with `text-sm font-medium text-slate-200` styling. Use `React.LabelHTMLAttributes<HTMLLabelElement>` and forwardRef. Add variant for error state with `text-red-500`.

3. **button.tsx** — Button with variants object pattern:
   - `default`: `bg-slate-50 text-slate-900 hover:bg-slate-200`
   - `destructive`: `bg-red-600 text-slate-50 hover:bg-red-700`
   - `outline`: `border border-slate-700 bg-transparent text-slate-50 hover:bg-slate-800`
   - `ghost`: `text-slate-50 hover:bg-slate-800`
   - Sizes: `default` (h-10 px-4 py-2), `sm` (h-9 px-3), `lg` (h-11 px-8), `icon` (h-10 w-10)
   - Use `disabled:pointer-events-none disabled:opacity-50` for disabled state
   - Support `asChild` prop using a simple conditional render (not Slot from radix, just render children if asChild)

4. **form.tsx** — React Hook Form integration components. This is a 'use client' component. Import `useFormContext`, `Controller`, `FormProvider` from react-hook-form. Create:
   - `Form` — wrapper around FormProvider
   - `FormField` — wrapper around Controller
   - `FormItem` — div with `space-y-2` class
   - `FormLabel` — Label that turns red on error
   - `FormControl` — passes form field props to child
   - `FormDescription` — small helper text in `text-sm text-slate-400`
   - `FormMessage` — error message display in `text-sm text-red-500`
   Use React context to pass field state (error, name) from FormField to child components.

   IMPORTANT: This component requires `react-hook-form` as a peer dependency. It will be installed in plan 02-04 when the submission form is built. The component file itself just needs to exist with correct imports.

5. **checkbox.tsx** — Simple checkbox with label support. Style: `h-4 w-4 rounded border-slate-700 bg-slate-800 text-slate-50 focus:ring-2 focus:ring-slate-400`. Use native HTML input type="checkbox" with custom styling wrapper.

6. **dialog.tsx** — Modal dialog using native HTML `<dialog>` element (not Radix). Create:
   - `Dialog` — context provider managing open state
   - `DialogTrigger` — button that opens dialog
   - `DialogContent` — the modal overlay and content card with `bg-slate-900 border border-slate-700 rounded-lg p-6 shadow-xl`. Use `fixed inset-0 z-50 flex items-center justify-center` for overlay. Close on overlay click and Escape key.
   - `DialogHeader` — flex column with gap
   - `DialogTitle` — `text-lg font-semibold text-slate-50`
   - `DialogDescription` — `text-sm text-slate-400`
   - `DialogFooter` — flex row with gap and justify-end
   - `DialogClose` — button that closes dialog

7. **badge.tsx** — Inline badge with variants:
   - `default`: `bg-slate-700 text-slate-200`
   - `success`: `bg-green-900 text-green-200`
   - `warning`: `bg-yellow-900 text-yellow-200`
   - `destructive`: `bg-red-900 text-red-200`
   - `outline`: `border border-slate-700 text-slate-200`
   Use `inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold`.

8. **table.tsx** — Table primitives for TanStack Table:
   - `Table` — `<table>` with `w-full caption-bottom text-sm`
   - `TableHeader` — `<thead>` with `border-b border-slate-700`
   - `TableBody` — `<tbody>` with `[&_tr:last-child]:border-0`
   - `TableFooter` — `<tfoot>` with border-top styling
   - `TableRow` — `<tr>` with `border-b border-slate-800 hover:bg-slate-800/50 transition-colors`
   - `TableHead` — `<th>` with `h-12 px-4 text-left align-middle font-medium text-slate-400`
   - `TableCell` — `<td>` with `p-4 align-middle text-slate-200`
   - `TableCaption` — `<caption>` with `mt-4 text-sm text-slate-400`
   All use forwardRef and cn() utility.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify all components compile. Verify each component file exists in src/components/ui/. Check that imports of cn() from '@/lib/utils' work (or create the utility if it doesn't exist — it may already exist from Phase 1 shadcn setup).
  </verify>
  <done>
Eight new UI components exist: textarea, label, button, form, checkbox, dialog, badge, table. All follow shadcn/ui patterns with forwardRef, cn() utility, and dark slate theme. Form component integrates with react-hook-form. Table component provides TanStack Table primitives.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes without errors
2. `src/lib/db/schema.ts` exports `submissions`, `Submission`, `NewSubmission`
3. `src/lib/validation/submission.ts` exports `submissionSchema`, `adminActionSchema`, `adminListingSchema`
4. All 8 UI component files exist in `src/components/ui/`
5. Migration files exist: `0002_add_submissions_table.sql`, `0003_add_trigram_indexes.sql`
</verification>

<success_criteria>
- Submissions table schema compiles and can generate valid SQL migration
- Zod schemas validate form data correctly (test with schema.parse())
- All UI components render without errors when imported
- No TypeScript compilation errors across the project
</success_criteria>

<output>
After completion, create `.planning/phases/02-submissions-admin/02-01-SUMMARY.md`
</output>
